{% extends 'base.html' %}
{% block header %}
{% endblock %}
{% block content %}
<main class="planner-page" style="padding: 2rem 1rem; max-width: 1200px; margin: 0 auto;">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <header style="margin-bottom: 2.5rem; text-align: center;">
    <h1 style="font-size: 2rem; font-weight: 700; color: var(--color-primary); margin-bottom: 0.5rem;">
      –°–æ–∑–¥–∞–π —Å–≤–æ—ë –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ
    </h1>
    <p style="color: var(--color-text-secondary); font-size: 1.1rem;">
      –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É ‚Äî –∏ –º—ã —Å–æ–±–µ—Ä—ë–º –¥–ª—è —Ç–µ–±—è –∏–¥–µ–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–æ–µ–∑–¥–∫–∏ üó∫Ô∏è
    </p>
  </header>

  <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è -->
  <section class="create-trip-form"
    style="background: var(--color-secondary); padding: 2rem; border-radius: 16px; margin-bottom: 3rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
    <h2 style="font-size: 1.5rem; color: var(--color-text); margin-bottom: 1.5rem;">–ù–æ–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</h2>

    <form method="post" style="display: grid; gap: 1.25rem;">
      {% csrf_token %}
      <div>
        <label for="trip-title"
          style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--color-text);">–ù–∞–∑–≤–∞–Ω–∏–µ
          –ø–æ–µ–∑–¥–∫–∏</label>
        <input name="title" type="text" id="trip-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ú–µ—á—Ç–∞—é –≤ –¢–æ–∫–∏–æ¬ª"
          style="width: 100%; padding: 12px; border: 1px solid var(--color-text-secondary); border-radius: 8px; background: var(--color-bg); color: var(--color-text); font-size: 1rem;">
      </div>

      <div>
        <label for="trip-description"
          style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--color-text);">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea name="discription" id="trip-description" rows="3"
          placeholder="–†–∞—Å—Å–∫–∞–∂–∏, –∑–∞—á–µ–º –µ–¥–µ—à—å –∏ —á—Ç–æ —Ö–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å..."
          style="width: 100%; padding: 12px; border: 1px solid var(--color-text-secondary); border-radius: 8px; background: var(--color-bg); color: var(--color-text); font-size: 1rem; resize: vertical;"></textarea>
      </div>

      <div>
        <label for="trip-country"
          style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--color-text);">–°—Ç—Ä–∞–Ω–∞</label>
        <select name="country" id="trip-country"
          style="width: 100%; padding: 12px; border: 1px solid var(--color-text-secondary); border-radius: 8px; background: var(--color-bg); color: var(--color-text); font-size: 1rem;">
          <option value="" disabled selected>–í—ã–±–µ—Ä–∏ —Å—Ç—Ä–∞–Ω—É</option>
          {% for country_name, code in countries %}
          <option value="{{ country_name }}">{{code}}</option>
          {% endfor %}
        </select>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div>
          <label for="trip-departure"
            style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--color-text);">–î–∞—Ç–∞
            –≤—ã–ª–µ—Ç–∞</label>
          <input name="date_in" type="date" id="trip-departure"
            style="width: 100%; padding: 12px; border: 1px solid var(--color-text-secondary); border-radius: 8px; background: var(--color-bg); color: var(--color-text);">
        </div>
        <div>
          <label for="trip-return"
            style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--color-text);">–î–∞—Ç–∞
            –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è</label>
          <input name="date_out" type="date" id="trip-return"
            style="width: 100%; padding: 12px; border: 1px solid var(--color-text-secondary); border-radius: 8px; background: var(--color-bg); color: var(--color-text);">
        </div>
        <div>
          <fieldset style="display: flex; flex-direction: column; border: none;">
            <div>
              <input type="radio" name="export" value="json">
              <label for="trip-export">–≠–∫—Å–ø–æ—Ä—Ç –≤ json</label>
            </div>

            <div>
              <input type="radio" name="export" value="xml">
              <label for="trip-export">–≠–∫—Å–ø–æ—Ä—Ç –≤ xml</label>
            </div>
<!-- 
            <div>
              <input type="radio" name="export" value="none">
              <label for="trip-export">–ù–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</label>
            </div> -->

            <div>
              <input type="radio" name="export" value="db">
              <label for="trip-export">–ó–∞–ø–∏—Å—å –≤ –±–¥</label>
            </div>
          </fieldset>
        </div>
      </div>

      <div>
        <label for="trip-budget"
          style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--color-text);">–ë—é–¥–∂–µ—Ç (–≤
          USD)</label>
        <input name="price" type="number" id="trip-budget" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2500"
          style="width: 100%; padding: 12px; border: 1px solid var(--color-text-secondary); border-radius: 8px; background: var(--color-bg); color: var(--color-text); font-size: 1rem;">
      </div>

      <button type="submit"
        style="background: var(--color-accent); color: white; border: none; padding: 14px 32px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; font-weight: 600; justify-self: start; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);">
        üó∫Ô∏è –°–æ–∑–¥–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ
      </button>
    </form>
  </section>

  <!-- –°–ø–∏—Å–æ–∫ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π -->
  <section class="existing-trips" style="margin-bottom: 3rem;">
    <h2
      style="font-size: 1.5rem; color: var(--color-text); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-accent);">
      –¢–≤–æ–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</h2>

    <form id="search-form"
      style="display: flex; flex-direction: row; gap: 1rem; margin-bottom: 2rem; align-items: center;">
      {% csrf_token %}
      <input type="text" name="search" id="search-input" value="{{ request.POST.search|default:'' }}"
        placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, —Å—Ç—Ä–∞–Ω–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."
        style="padding: 10px; border-radius: 8px; border: 1px solid var(--color-text-secondary); background: var(--color-bg); color: var(--color-text); flex: 1;">

      <fieldset style="display: flex; gap: 1rem; align-items: center; border: none;">
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="radio" name="result_type" value="json" {% if request.POST.result_type == 'json' %}checked{% endif %}>
          –∏–∑ XML/JSON
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="radio" name="result_type" value="db" {% if request.POST.result_type == 'db' %}checked{% endif %}>
          –∏–∑ –ë–î
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="radio" name="result_type" value="" {% if request.POST.result_type != 'json' and request.POST.result_type != "db" %}checked{% endif %}>
          –í–µ–∑–¥–µ
        </label>
      </fieldset>
    </form>

    <div id="trips-container">
      {% include 'trip_cards.html' %}
    </div>
  </section>
</main>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('search-form');
    const input = document.getElementById('search-input');
    const container = document.getElementById('trips-container');

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ AJAX
    const performSearch = async () => {
      const formData = new FormData(form);

      try {
        const response = await fetch("{% url 'ajax_search_trips' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          }
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');

        const html = await response.text();
        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<div style="color: red; padding: 1rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
        console.error(error);
      }
    };

    // –î–µ–±–∞—É–Ω—Å ‚Äî —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏
    let debounceTimer;
    const debounce = (func, delay) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(func, delay);
    };

    // –°–ª—É—à–∞–µ–º –≤–≤–æ–¥ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    input.addEventListener('input', () => {
      debounce(performSearch, 300); // –∂–¥—ë–º 300 –º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–≤–æ–¥–∞
    });

    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫
    form.querySelectorAll('input[name="result_type"]').forEach(radio => {
      radio.addEventListener('change', performSearch);
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞ –∏–∑ cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}